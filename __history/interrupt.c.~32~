#include <18F4520.h>

#fuses NOWDT, HS, PUT, NOPROTECT, NOLVP
#use delay(crystal=20000000)
#byte    portd    =  0xff83
#byte    portc    =  0xff82
#byte    porta    =  0xff80
#bit     sensor   =  porta.4
#bit     led_mode =  portc.3
#bit     buzz     =  portc.2
#bit     tens     =  portc.1
#bit     units    =  portc.0
#bit     mode     =  0xff81.0
#bit     status   =  portc.5

const unsigned char number[10]={
                                 0xc0,
                                 0xf9,
                                 0xa4,
                                 0xb0,
                                 0x99,
                                 0x92,
                                 0x82,
                                 0xf8,
                                 0x80,
                                 0x90
};

unsigned int8 t0, dem;

#int_ext
void modeSelection(){
   if(dem==0){
      dem=1;
   }
   else{
      dem=0;
   }
}
void display(){
   portd = number[t0%10];
   units = 1;
   tens  = 0;
   delay_ms(1);
   
   portd = number[t0/10];
   tens  = 1;
   units = 0;
   delay_ms(1);
}

void main(){
   set_tris_d(0x00);
   set_tris_c(0x00);
   set_tris_a(0xff);
   buzz = 0;
   dem = 0;
   
   setup_timer_0(T0_EXT_L_TO_H | T0_DIV_1);
   set_timer0(0);
   enable_interrupts(global);
   enable_interrupts(int_ext_L2H);
   while(1){
      led_mode=0;
      t0 = get_timer0();
      buzz = 0;
      while(sensor==1 & dem==0){
         buzz = 1;
         display();
      }
      display();
      
      if(t0==100){
         set_timer0(0);
      }
      while(dem==1){
         led_mode = 1;
         t0 = 69;
         display();
         if(status==1){
            delay_ms(20);
            if(status==1){
               buzz=1;
               while(status==1);
            }
            
         }
      }
      /*while(dem==0){
         t0=96;
         display();
      }*/
   } 
}
